<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    










    







<script defer language="javascript" type="text/javascript" src="/js/bundle.min.5991d603939a6d188be342b278a4555db90f163903158c623d2c39fde3d82cb3.js"></script>






    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">

    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    
    <link rel="icon" href=/images/favicon.ico>

    
    





  





  
  
  


<!-- Open Graph image and Twitter Card metadata -->

<title itemprop="name">Phin3has Tech Blog - Running Sublime Security in K8s</title>
<meta property="og:title" content=Phin3has&#32;Tech&#32;Blog&#32;-&#32;Running&#32;Sublime&#32;Security&#32;in&#32;K8s />
<meta name="twitter:title" content=Phin3has&#32;Tech&#32;Blog&#32;-&#32;Running&#32;Sublime&#32;Security&#32;in&#32;K8s />
<meta itemprop="name" content=Phin3has&#32;Tech&#32;Blog&#32;-&#32;Running&#32;Sublime&#32;Security&#32;in&#32;K8s />
<meta name="application-name" content=Phin3has&#32;Tech&#32;Blog&#32;-&#32;Running&#32;Sublime&#32;Security&#32;in&#32;K8s />
<meta property="og:site_name" content="" />


<meta name="description" content="" />
<meta itemprop="description" content="" />
<meta property="og:description" content="" />
<meta name="twitter:description" content="" />


<base href="//localhost:1313/posts/running-sublime-security-in-k8s/" />
<link rel="canonical" href="//localhost:1313/posts/running-sublime-security-in-k8s/" itemprop="url" />
<meta name="url" content="//localhost:1313/posts/running-sublime-security-in-k8s/" />
<meta name="twitter:url" content="//localhost:1313/posts/running-sublime-security-in-k8s/" />
<meta property="og:url" content="//localhost:1313/posts/running-sublime-security-in-k8s/" />


<meta property="og:updated_time" content="2025-07-26T11:41:42-06:00" />


<link rel="sitemap" type="application/xml" title="Sitemap" href='//localhost:1313/sitemap.xml' />

<meta name="robots" content="index,follow" />
<meta name="googlebot" content="index,follow" />



  
    <meta name="twitter:site" content="@phin3has" />
    <meta name="twitter:creator" content="@phin3has" />

<meta property="fb:admins" content="" />


<meta name="apple-mobile-web-app-title" content="" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black" />






<meta name="generator" content="Hugo 0.145.0">


    
    

<link type="text/css" rel="stylesheet" href="/css/bundle.min.94a339836f89f0d25f31980cb6b0631da21e20af128308747ce44e0525eb16ef.css">


    
    <style>
    body {
        --sidebar-bg-color: #202020;
        --sidebar-img-border-color: #515151;
        --sidebar-p-color: #909090;
        --sidebar-h1-color: #FFF;
        --sidebar-a-color: #FFF;
        --sidebar-socials-color: #FFF;
        --text-color: #222;
        --bkg-color: #FAF9F6;
        --post-title-color: #303030;
        --list-color: #5A5A5A;
        --link-color: #268BD2;
        --date-color: #515151;
        --table-border-color: #E5E5E5;
        --table-stripe-color: #F9F9F9;
        --code-color: #000;
        --code-background-color: #E5E5E5;
        --code-block-color: #FFF;
        --code-block-background-color: #272822;
        --moon-sun-color: #FFF;
        --moon-sun-background-color: #515151;
    }
    body.dark-theme {
        --text-color: #EEE;
        --bkg-color: #121212;
        --post-title-color: #DBE2E9;
        --list-color: #9D9D9D;
        --link-color: #268BD2;
        --date-color: #9A9A9A;
        --table-border-color: #515151;
        --table-stripe-color: #202020;
        --code-color: #FFF;
        --code-background-color: #515151;
        --code-block-color: #FFF;
        --code-block-background-color: #272822;
    }
    body {
        background-color: var(--bkg-color);
    }
</style>


    
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    mermaid.initialize({
      startOnLoad: true,
      theme: 'default',
      securityLevel: 'loose',
      flowchart: { useMaxWidth: false, htmlLabels: true }
    });
  });
</script>
</head>

    <body class="dark-theme">
        <div class="wrapper">
            <aside class="sidebar">
    <div class="container sidebar-sticky">
        <div class="light-dark" align="right">
    <button class="btn-light-dark" title="Toggle light/dark mode">
        <svg class="moon" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 16 16">
            <path fill="currentColor" d="M6 .278a.768.768 0 0 1 .08.858a7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277c.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316a.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71C0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"/>
        </svg>
        <svg class="sun" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 16 16">
            <path fill="currentColor" d="M8 12a4 4 0 1 0 0-8a4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"/>
        </svg>
    </button>
</div>

        <div class="sidebar-about">
    <h1 class="brand">
        
            <a href="//localhost:1313/">
                <img src="/images/skull_pic.jpg" alt="brand image">
            </a>
        
        
            <a href="//localhost:1313/">
                <h1>Phin3has Tech Blog</h1>
            </a>
        
    </h1>
    <p class="lead">
    Dropping my notes on Cloud and DevSecOps...
    </p>
</div>

        <nav>
    <ul class="sidebar-nav">

        
        
        
        
            

            
                
                
                    <li class="heading">
                        <a href="/about/">About</a>
                    </li>
                    
                
            
                
                
            
            
                
                
            
                
                
            
        
        
            

            
                
                
            
                
                
                    <li class="heading">
                        <a href="/posts/">Posts</a>
                    </li>
                    
                        <li class="sub-heading">
                            Recent
                        </li>
                        
                            <li class="bullet">
                                <a href="//localhost:1313/posts/running-sublime-security-in-k8s/">Running Sublime Security in K8s</a>
                            </li>
                        
                            <li class="bullet">
                                <a href="//localhost:1313/posts/finding-hardware/">Getting Started with Home Lab Equipment on a Budget</a>
                            </li>
                        
                            <li class="bullet">
                                <a href="//localhost:1313/posts/talos-longhorn/">Installing Longhorn on Talos Linux: A Step-by-Step Guide</a>
                            </li>
                        
                            <li class="bullet">
                                <a href="//localhost:1313/posts/hello-world/">Hello World</a>
                            </li>
                        
                    
                
            
            
                
                
            
                
                
            
        

    </ul>
</nav>

        
    <a target="_blank" class="social" title="GitHub" href="https://github.com/phin3has">
        <svg xmlns="http://www.w3.org/2000/svg" width="1.2em" height="1.2em" viewBox="-2 -2 24 24">
            <path fill="currentColor" d="M18.88 1.099C18.147.366 17.265 0 16.233 0H3.746C2.714 0 1.832.366 1.099 1.099C.366 1.832 0 2.714 0 3.746v12.487c0 1.032.366 1.914 1.099 2.647c.733.733 1.615 1.099 2.647 1.099H6.66c.19 0 .333-.007.429-.02a.504.504 0 0 0 .286-.169c.095-.1.143-.245.143-.435l-.007-.885c-.004-.564-.006-1.01-.006-1.34l-.3.052c-.19.035-.43.05-.721.046a5.555 5.555 0 0 1-.904-.091a2.026 2.026 0 0 1-.872-.39a1.651 1.651 0 0 1-.572-.8l-.13-.3a3.25 3.25 0 0 0-.41-.663c-.186-.243-.375-.407-.566-.494l-.09-.065a.956.956 0 0 1-.17-.156a.723.723 0 0 1-.117-.182c-.026-.061-.004-.111.065-.15c.07-.04.195-.059.378-.059l.26.04c.173.034.388.138.643.311a2.1 2.1 0 0 1 .631.677c.2.355.44.626.722.813c.282.186.566.28.852.28c.286 0 .533-.022.742-.065a2.59 2.59 0 0 0 .585-.196c.078-.58.29-1.028.637-1.34a8.907 8.907 0 0 1-1.333-.234a5.314 5.314 0 0 1-1.223-.507a3.5 3.5 0 0 1-1.047-.872c-.277-.347-.505-.802-.683-1.365c-.177-.564-.266-1.215-.266-1.952c0-1.049.342-1.942 1.027-2.68c-.32-.788-.29-1.673.091-2.652c.252-.079.625-.02 1.119.175c.494.195.856.362 1.086.5c.23.14.414.257.553.352a9.233 9.233 0 0 1 2.497-.338c.859 0 1.691.113 2.498.338l.494-.312a6.997 6.997 0 0 1 1.197-.572c.46-.174.81-.221 1.054-.143c.39.98.424 1.864.103 2.653c.685.737 1.028 1.63 1.028 2.68c0 .737-.089 1.39-.267 1.957c-.177.568-.407 1.023-.689 1.366a3.65 3.65 0 0 1-1.053.865c-.42.234-.828.403-1.223.507a8.9 8.9 0 0 1-1.333.235c.45.39.676 1.005.676 1.846v3.11c0 .147.021.266.065.357a.36.36 0 0 0 .208.189c.096.034.18.056.254.064c.074.01.18.013.318.013h2.914c1.032 0 1.914-.366 2.647-1.099c.732-.732 1.099-1.615 1.099-2.647V3.746c0-1.032-.367-1.914-1.1-2.647z"/>
        </svg>
    </a>



    <a target="_blank" class="social" title="LinkedIn" href="https://www.linkedin.com/in/brandonedmunds/">
        <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1.2em" viewBox="0 0 448 512">
            <path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5c0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7c-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5c67.2 0 79.7 44.3 79.7 101.9V416z"/>
        </svg>
    </a>



    <a target="_blank" class="social" title="X" href="https://x.com/phin3has">
        <svg xmlns="http://www.w3.org/2000/svg" width="1.1em" height="1.1em" viewBox="0 0 512 472.799">
            <path fill="currentColor" d="M403.229 0h78.506L310.219 196.04 512 462.799H354.002L230.261 301.007 88.669 462.799h-78.56l183.455-209.683L0 0h161.999l111.856 147.88L403.229 0zm-27.556 415.805h43.505L138.363 44.527h-46.68l283.99 371.278z"/>
        </svg>
    </a>





    <a target="_blank" class="social" title="Discord" href="https://discord.com/users/phin3has">
        <svg xmlns="http://www.w3.org/2000/svg" width="1.2em" height="1.2em" viewBox="0 0 24 24">
            <path fill="currentColor" d="M19.27 5.33C17.94 4.71 16.5 4.26 15 4a.09.09 0 0 0-.07.03c-.18.33-.39.76-.53 1.09a16.09 16.09 0 0 0-4.8 0c-.14-.34-.35-.76-.54-1.09c-.01-.02-.04-.03-.07-.03c-1.5.26-2.93.71-4.27 1.33c-.01 0-.02.01-.03.02c-2.72 4.07-3.47 8.03-3.1 11.95c0 .02.01.04.03.05c1.8 1.32 3.53 2.12 5.24 2.65c.03.01.06 0 .07-.02c.4-.55.76-1.13 1.07-1.74c.02-.04 0-.08-.04-.09c-.57-.22-1.11-.48-1.64-.78c-.04-.02-.04-.08-.01-.11c.11-.08.22-.17.33-.25c.02-.02.05-.02.07-.01c3.44 1.57 7.15 1.57 10.55 0c.02-.01.05-.01.07.01c.11.09.22.17.33.26c.04.03.04.09-.01.11c-.52.31-1.07.56-1.64.78c-.04.01-.05.06-.04.09c.32.61.68 1.19 1.07 1.74c.03.01.06.02.09.01c1.72-.53 3.45-1.33 5.25-2.65c.02-.01.03-.03.03-.05c.44-4.53-.73-8.46-3.1-11.95c-.01-.01-.02-.02-.04-.02zM8.52 14.91c-1.03 0-1.89-.95-1.89-2.12s.84-2.12 1.89-2.12c1.06 0 1.9.96 1.89 2.12c0 1.17-.84 2.12-1.89 2.12zm6.97 0c-1.03 0-1.89-.95-1.89-2.12s.84-2.12 1.89-2.12c1.06 0 1.9.96 1.89 2.12c0 1.17-.83 2.12-1.89 2.12z"/>
        </svg>
    </a>









    <a target="_blank" class="social" title="RSS Feed" href="/posts/index.xml">
        <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1.2em" viewBox="0 0 1280.000000 1280.000000">
            <g transform="translate(0.000000,1280.000000) scale(0.100000,-0.100000)" fill="currentColor">
                <path d="M2295 11929 c-284 -12 -642 -45 -707 -65 -17 -5 -18 -63 -18 -1039 0 -569 4 -1036 8 -1039 5 -3 74 6 153 19 510 86 1168 95 1789 25 1348 -153 2602 -677 3670 -1531 385 -308 820 -744 1126 -1129 842 -1060 1362 -2313 1514 -3650 70 -621 61 -1279 -25 -1789 -13 -79 -22 -148 -19 -153 3 -4 471 -8 1039 -8 l1035 0 5 23 c51 225 85 942 67 1419 -23 605 -77 1044 -198 1617 -294 1400 -927 2734 -1823 3846 -1043 1295 -2364 2259 -3909 2854 -1158 447 -2451 656 -3707 600z"/>
                <path d="M2255 7845 c-269 -25 -620 -81 -667 -106 -17 -9 -18 -55 -18 -899 0 -706 3 -890 13 -890 6 0 66 18 132 41 130 44 288 79 467 105 154 21 577 30 749 15 1207 -107 2267 -823 2814 -1902 166 -327 268 -637 330 -1001 38 -227 48 -384 42 -662 -8 -348 -44 -590 -126 -831 -23 -66 -41 -126 -41 -132 0 -10 184 -13 890 -13 844 0 890 1 899 18 27 50 88 452 110 725 14 162 14 624 1 782 -59 703 -233 1323 -545 1945 -481 956 -1313 1788 -2270 2268 -620 310 -1239 483 -1940 542 -165 14 -669 10 -840 -5z"/>
                <path d="M2519 3815 c-391 -66 -725 -336 -868 -703 -79 -201 -96 -462 -45 -677 83 -344 338 -641 666 -774 116 -47 205 -69 330 -80 412 -39 811 153 1040 500 193 292 240 648 128 981 -135 403 -492 699 -914 757 -100 14 -241 12 -337 -4z"/>
            </g>
        </svg>
    </a>


    <a target="_blank" class="social" title="Email" href="mailto://phin3has@protonmail.com">
       <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1.2em" viewBox="0 0 485.211 485.211">
            <path fill="currentColor" d="M301.393,241.631L464.866,424.56H20.332l163.474-182.928l58.801,51.443L301.393,241.631z M462.174,60.651H23.027 l219.579,192.142L462.174,60.651z M324.225,221.67l160.986,180.151V80.792L324.225,221.67z M0,80.792v321.029L160.972,221.64 L0,80.792z"/>
       </svg>
    </a>




        <p class="footnote">
powered by <a target="_blank" href="https://gohugo.io">Hugo</a> | themed with <a target="_blank" href="https://github.com/lukeorth/poison">poison</a>
    <br>
    &copy; 2025 . All rights reserved.
</p>

  </div>
</aside>

            <main class="content container">
                <div class="post">
  <div class="info">
  <h1 class="post-title">
    <a href="//localhost:1313/posts/running-sublime-security-in-k8s/">Running Sublime Security in K8s</a>
  </h1>

  <div class="headline">
    <div>
      
      
      <time datetime=" 2025-07-26T11:41:42-0600" class="post-date">
        July 26, 2025
      </time>
      
      <span> - </span>
      <span class="reading-time">
        
          
        

        <span>8 mins read</span>
      </span>
    </div>

    
  </div>

  
  

  
</div>

  <h1 id="sublime-security-on-kubernetes-a-home-labbers-journey-through-email-security-and-sso-poo">Sublime Security on Kubernetes: A Home Labber&rsquo;s Journey Through Email Security and SSO Poo</h1>
<p><em>Or: How I Spent Two Days Fighting Authentik SAML Only to Discover It Was a Simple Environment Variable</em></p>
<h2 id="the-beginning-this-looks-cool">The Beginning: &ldquo;This Looks Cool!&rdquo;</h2>
<p>Picture this: It&rsquo;s a Thursday evening and you stumble upon Sublime Security - an &ldquo;open&rdquo; email security platform that promises to protect your homelab email with the same sophistication as enterprise solutions. Their Docker quickstart? One line: <code>curl -sL https://sublime.security/install.sh | sh</code>.</p>
<p>&ldquo;How hard could it be to run this on Kubernetes?&rdquo; you think. &ldquo;I&rsquo;ll just convert the Docker Compose file, slap it behind Authentik, and call it a night.&rdquo;</p>
<p><em>Narrator: It was not, in fact, called a night.</em></p>
<h2 id="why-sublime-security">Why Sublime Security?</h2>
<p>Before we dive into the trenches, let&rsquo;s talk about why Sublime Security is worth the effort:</p>
<ul>
<li><strong>Detection-as-Code</strong>: Write email security rules like you write code</li>
<li><strong>Transparency</strong>: See exactly how threats are detected (no black box nonsense)</li>
<li><strong>Community-Driven</strong>: 1,200+ detection rules with a third from the community</li>
<li><strong>Strelka Integration</strong>: Enterprise-grade file scanning from Target&rsquo;s security team</li>
<li><strong>ML-Powered</strong>: Actual AI that does useful things (shocking, I know)</li>
<li><strong>Free for up to 600 mailboxes</strong>: Perfect for home labs!</li>
</ul>
<h2 id="the-challenge-docker-compose--kubernetes">The Challenge: Docker Compose â†’ Kubernetes</h2>
<p>Sublime provides a nice Docker Compose setup, but we&rsquo;re Kubernetes people here. We don&rsquo;t do &ldquo;docker-compose up&rdquo; - we do &ldquo;kubectl apply -f&rdquo; with 37 YAML files and YOLO vibes.</p>
<p>Here&rsquo;s what we&rsquo;re dealing with:</p>
<ul>
<li><strong>9 different services</strong> (Mantis, Bora-lite, Dashboard, PostgreSQL, Redis, Strelka components, MinIO)</li>
<li><strong>Complex inter-service communication</strong></li>
<li><strong>Persistent storage requirements</strong></li>
<li><strong>No official Kubernetes support</strong> (that&rsquo;s right, we&rsquo;re pioneers!)</li>
<li><strong>Integration with Authentik for SSO</strong></li>
</ul>
<h2 id="prerequisites-what-youll-need">Prerequisites: What You&rsquo;ll Need</h2>
<p>Before we start this adventure, make sure you have:</p>
<ol>
<li><strong>A Kubernetes cluster</strong> (k3s, k8s, whatever floats your boat)</li>
<li><strong>Traefik</strong> as your ingress controller (or adapt for nginx/others)</li>
<li><strong>Authentik</strong> deployed and working</li>
<li><strong>Cloudflare Tunnel</strong> or similar for external access</li>
<li><strong>ArgoCD</strong> (optional but recommended for GitOps)</li>
<li><strong>Patience</strong> (required for the SSO debugging)</li>
<li><strong>Coffee</strong> (lots of it)</li>
</ol>
<h2 id="step-1-understanding-the-architecture">Step 1: Understanding the Architecture</h2>
<p>First, let&rsquo;s understand what we&rsquo;re building. Sublime Security isn&rsquo;t just one container - it&rsquo;s an entire ecosystem:</p>


<script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';

    const lsTheme = localStorage.getItem("theme")
    const hugoTheme = document.body.classList.contains("dark-theme") ? "dark" : null
    const currTheme = lsTheme ? lsTheme : hugoTheme;
    const mermaidTheme = currTheme == "light" ? "default" : "dark"

    mermaid.initialize({
        theme: mermaidTheme,
        themeVariables: {
            background: '#ffffff',
            primaryTextColor: '#000000',
            secondaryTextColor: '#000000',
            tertiaryTextColor: '#000000',
            textColor: '#000000'
        }
    });
</script>

<style>
.mermaid {
    background-color: white !important;
    padding: 10px;
    width: 100% !important;
    max-width: 100% !important;
}

 
.mermaid svg {
    background-color: white !important;
    width: 100% !important;
    max-width: 100% !important;
    height: auto !important;
}

 
.mermaid svg text,
.mermaid svg .node text,
.mermaid svg .edgeLabel text,
.mermaid svg .label text,
.mermaid svg tspan,
.mermaid svg g text,
.mermaid svg g.node text,
.mermaid svg g.edgeLabel text {
    fill: black !important;
    color: black !important;
    stroke: none !important;
}

 
.mermaid svg * {
    color: black !important;
}

.mermaid svg *[fill="white"],
.mermaid svg *[fill="#ffffff"],
.mermaid svg *[fill="rgb(255,255,255)"] {
    fill: black !important;
}
</style>



<pre class="mermaid">
graph TB
    Internet[Internet] --> CF[Cloudflare Tunnel]
    CF --> Traefik[Traefik Ingress]
    Traefik --> Auth[Authentik Middleware]
    
    Auth --> |sublime.domain.com| Dashboard[Dashboard :3000]
    Auth --> |sublime-api.domain.com| Mantis[Mantis API :8000]
    
    Mantis --> Bora[Bora-lite<br/>Task Queue]
    Mantis --> PG[(PostgreSQL)]
    Mantis --> Redis[(Redis)]
    Mantis --> Strelka{Strelka}
    Mantis --> MinIO[(MinIO<br/>S3-like)]
    
    Bora --> PG
    Bora --> Redis
    Bora --> Strelka
    
    Strelka --> |Components| StrelkaComp[Frontend<br/>Backend<br/>Manager<br/>Coordinator]
    
    Mantis --> Hydra[Hydra<br/>ML/AI]
    Bora --> Hydra
    
    Dashboard --> |API Calls| Mantis
    
    style Internet fill:#e1e1e1
    style CF fill:#f89620
    style Traefik fill:#24a0ed
    style Auth fill:#fd4e2e
    style Dashboard fill:#4CAF50
    style Mantis fill:#2196F3
    style Bora fill:#FF9800
    style PG fill:#336791
    style Redis fill:#DC382D
    style MinIO fill:#c72e49
    style Hydra fill:#9C27B0
    style Strelka fill:#00BCD4
</pre>

<h2 id="step-2-setting-up-the-namespace-and-secrets">Step 2: Setting Up the Namespace and Secrets</h2>
<p>Let&rsquo;s start with the basics. Create your namespace and secrets:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Create the namespace</span>
</span></span><span style="display:flex;"><span>kubectl create namespace sublime
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Generate secure passwords</span>
</span></span><span style="display:flex;"><span>export POSTGRES_PASSWORD<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>openssl rand -base64 32<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>export JWT_SECRET<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>openssl rand -base64 64<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>export POSTGRES_ENCRYPTION_KEY<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>openssl rand -base64 32<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Create the secret (we&#39;ll use SealedSecrets later)</span>
</span></span><span style="display:flex;"><span>kubectl create secret generic sublime-secrets <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --namespace<span style="color:#f92672">=</span>sublime <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --from-literal<span style="color:#f92672">=</span>POSTGRES_PASSWORD<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$POSTGRES_PASSWORD<span style="color:#e6db74">&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --from-literal<span style="color:#f92672">=</span>JWT_SECRET<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$JWT_SECRET<span style="color:#e6db74">&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --from-literal<span style="color:#f92672">=</span>POSTGRES_ENCRYPTION_KEY<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$POSTGRES_ENCRYPTION_KEY<span style="color:#e6db74">&#34;</span>
</span></span></code></pre></div><h2 id="step-3-deploy-postgresql">Step 3: Deploy PostgreSQL</h2>
<p>PostgreSQL needs special attention - the PGDATA path must be a subdirectory:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">sublime-postgres</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">sublime</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">sublime-postgres</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">sublime-postgres</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">postgres</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">postgres:13.2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">args</span>: [<span style="color:#e6db74">&#34;-c&#34;</span>, <span style="color:#e6db74">&#34;max_connections=200&#34;</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">env</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">POSTGRES_USER</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">value</span>: <span style="color:#ae81ff">sublime</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">POSTGRES_DB</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">value</span>: <span style="color:#ae81ff">mantis</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">PGDATA</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">value: /data/postgres/pgdata  # CRITICAL</span>: <span style="color:#ae81ff">Must be subdirectory!</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">POSTGRES_PASSWORD</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">valueFrom</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">secretKeyRef</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">name</span>: <span style="color:#ae81ff">sublime-secrets</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">key</span>: <span style="color:#ae81ff">POSTGRES_PASSWORD</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">5432</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">volumeMounts</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">postgres-storage</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/data/postgres</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">postgres-storage</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">persistentVolumeClaim</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">claimName</span>: <span style="color:#ae81ff">sublime-postgres-pvc</span>
</span></span></code></pre></div><h2 id="step-4-deploy-redis-and-minio">Step 4: Deploy Redis and MinIO</h2>
<p>These are straightforward, but remember MinIO needs bucket initialization:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># MinIO deployment snippet</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">batch/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Job</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">sublime-create-buckets</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">sublime</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">restartPolicy</span>: <span style="color:#ae81ff">OnFailure</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">initContainers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">wait-for-minio</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox:1.28</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#39;sh&#39;</span>, <span style="color:#e6db74">&#39;-c&#39;</span>, <span style="color:#e6db74">&#39;until nc -zv sublimes3 8110; do echo &#34;waiting for minio...&#34;; sleep 2; done;&#39;</span>]
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">create-buckets</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">minio/mc</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">command</span>: 
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">/bin/sh</span>
</span></span><span style="display:flex;"><span>        - -<span style="color:#ae81ff">c</span>
</span></span><span style="display:flex;"><span>        - |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          sleep 15  # Give MinIO time to fully start
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          /usr/bin/mc alias set myminio http://sublimes3:8110 minioadmin minioadmin
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          /usr/bin/mc mb myminio/email-screenshots || true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          /usr/bin/mc ls myminio</span>
</span></span></code></pre></div><h2 id="step-5-the-strelka-beast">Step 5: The Strelka Beast</h2>
<p>Strelka is complex - it needs a coordinator, frontend, backend, and manager. Here&rsquo;s the key insight: ConfigMaps for configuration!</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ConfigMap</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">strelka-frontend-config</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">sublime</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">data</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">frontend.yaml</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    server: &#34;:57314&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    coordinator:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      addr: &#39;sublime-strelka-coordinator:6379&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      db: 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      pool: 100
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      read: 10s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    response:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      log: &#34;/var/log/strelka/strelka.log&#34;</span>
</span></span></code></pre></div><h2 id="step-6-the-core-services---mantis-and-bora-lite">Step 6: The Core Services - Mantis and Bora-lite</h2>
<p>Here&rsquo;s where things get interesting. These services need specific environment variables:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># Critical environment variables for Mantis</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">env</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">STRELKA_URL</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">value</span>: <span style="color:#ae81ff">sublime-strelka-frontend </span> <span style="color:#75715e"># Just hostname, no port!</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">CORS_ALLOW_ORIGINS</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;https://sublime.phin3has.me&#34;</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">BASE_URL</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;https://sublime.phin3has.me&#34;</span>  <span style="color:#75715e"># THE CRITICAL FIX!</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">DASHBOARD_PUBLIC_BASE_URL</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;https://sublime.phin3has.me&#34;</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">API_PUBLIC_BASE_URL</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;https://sublime-api.phin3has.me&#34;</span>
</span></span></code></pre></div><h2 id="step-7-the-ingress-dance">Step 7: The Ingress Dance</h2>
<p>Set up two ingresses - one for the dashboard, one for the API:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">networking.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Ingress</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">sublime-api</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">sublime</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">external-dns.alpha.kubernetes.io/hostname</span>: <span style="color:#ae81ff">sublime-api.phin3has.me</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">external-dns.alpha.kubernetes.io/target</span>: <span style="color:#ae81ff">YOUR-TUNNEL-ID.cfargotunnel.com</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># We&#39;ll add this later after setup</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># traefik.ingress.kubernetes.io/router.middlewares: traefik-authentik-forward-auth@kubernetescrd</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ingressClassName</span>: <span style="color:#ae81ff">traefik</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">sublime-api.phin3has.me</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">http</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">pathType</span>: <span style="color:#ae81ff">Prefix</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">service</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">name</span>: <span style="color:#ae81ff">sublime-mantis</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">port</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">number</span>: <span style="color:#ae81ff">8000</span>
</span></span></code></pre></div><h2 id="step-8-initial-setup-before-sso">Step 8: Initial Setup (Before SSO)</h2>
<p>First, deploy everything WITHOUT authentication:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Apply all your manifests</span>
</span></span><span style="display:flex;"><span>kubectl apply -f apps/sublime/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Wait for everything to be ready</span>
</span></span><span style="display:flex;"><span>kubectl wait --for<span style="color:#f92672">=</span>condition<span style="color:#f92672">=</span>ready pod -l app<span style="color:#f92672">=</span>sublime-mantis -n sublime --timeout<span style="color:#f92672">=</span>300s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Check the API health</span>
</span></span><span style="display:flex;"><span>curl https://sublime-api.phin3has.me/v1/health
</span></span></code></pre></div><p>Create your admin account through the API (the dashboard might have SSR issues initially).</p>
<h2 id="step-9-the-sso-saga-begins">Step 9: The SSO Saga Begins</h2>
<p>Now for the fun part - setting up SSO with Authentik. This is where I lost two days of my life.</p>
<h3 id="setting-up-saml-in-authentik">Setting up SAML in Authentik:</h3>
<ol>
<li>
<p><strong>Create a SAML Provider:</strong></p>
<pre tabindex="0"><code>Name: Sublime SAML Provider
ACS URL: https://sublime-api.phin3has.me/v0/organizations/YOUR-ORG-ID/saml
Issuer: (same as ACS URL)
Service Provider Binding: Post
Audience: (same as ACS URL)
Name ID Property: Email
</code></pre></li>
<li>
<p><strong>Create an Application:</strong></p>
<pre tabindex="0"><code>Name: Sublime Platform
Slug: sublime
Provider: (select your SAML provider)
</code></pre></li>
<li>
<p><strong>Get the metadata URL</strong> from Authentik</p>
</li>
<li>
<p><strong>Configure Sublime</strong> (through the admin panel once you&rsquo;re logged in)</p>
</li>
</ol>
<h3 id="the-plot-twist-its-not-saml-its-the-redirect">The Plot Twist: It&rsquo;s Not SAML, It&rsquo;s the Redirect!</h3>
<p>Here&rsquo;s what happened: Everything was configured correctly, but after authentication, Sublime was redirecting to <code>https://sublime-api.phin3has.me/login?error=SSO_ERROR</code> - which doesn&rsquo;t exist because the login page is on the dashboard domain!</p>
<p>The culprit? Sublime uses <code>BASE_URL</code> for post-authentication redirects, not <code>DASHBOARD_PUBLIC_BASE_URL</code> like you&rsquo;d expect.</p>
<p><strong>The fix:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># In mantis deployment</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">BASE_URL</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;https://sublime.phin3has.me&#34;</span>  <span style="color:#75715e"># NOT the API URL!</span>
</span></span></code></pre></div><h3 id="alternative-use-oidc-instead">Alternative: Use OIDC Instead</h3>
<p>After the SAML nightmare, I discovered OIDC works great too:</p>
<ol>
<li>
<p><strong>Create an OAuth2/OpenID Provider in Authentik:</strong></p>
<pre tabindex="0"><code>Client type: Confidential
Redirect URIs: https://sublime-api.phin3has.me/v0/organizations/YOUR-ORG-ID/oidc/callback
Scopes: openid, email, profile
Subject mode: Based on the User&#39;s Email
</code></pre></li>
<li>
<p><strong>Configure in Sublime:</strong></p>
<pre tabindex="0"><code>Issuer URL: https://auth.yourdomain.com/application/o/sublime/
Client ID: (from Authentik)
Client Secret: (from Authentik)
</code></pre></li>
</ol>
<h2 id="troubleshooting-tips">Troubleshooting Tips</h2>
<h3 id="connection-refused-or-502-bad-gateway">&ldquo;Connection refused&rdquo; or &ldquo;502 Bad Gateway&rdquo;</h3>
<ul>
<li>Check service names and ports</li>
<li>Verify pods are actually running: <code>kubectl get pods -n sublime</code></li>
<li>Check logs: <code>kubectl logs -f deployment/sublime-mantis -n sublime</code></li>
</ul>
<h3 id="sso_error-after-authentication">&ldquo;SSO_ERROR&rdquo; after authentication</h3>
<ul>
<li>Check the <code>BASE_URL</code> environment variable</li>
<li>Verify the user exists in Sublime with the same email</li>
<li>Check time synchronization between servers</li>
</ul>
<h3 id="dashboard-shows-500-error">Dashboard shows 500 error</h3>
<ul>
<li>This is a known SSR issue with the Docker image</li>
<li>The API still works fine</li>
<li>Use port-forwarding for local access if needed</li>
</ul>
<h3 id="strelka-connection-issues">Strelka connection issues</h3>
<ul>
<li>Use just the hostname, not hostname:port</li>
<li>Verify the coordinator is running</li>
<li>Check Redis connectivity</li>
</ul>
<h2 id="lessons-learned">Lessons Learned</h2>
<ol>
<li><strong>Always check environment variables</strong> - The <code>BASE_URL</code> issue cost me two days</li>
<li><strong>Start without authentication</strong> - Get it working first, then add security</li>
<li><strong>Read the logs carefully</strong> - The clues are usually there</li>
<li><strong>OIDC &gt; SAML</strong> - Simpler is often better</li>
<li><strong>Document everything</strong> - Your future self will thank you</li>
</ol>
<h2 id="the-victory-lap">The Victory Lap</h2>
<p>After two days of debugging, multiple coffee pots, and questioning my life choices, Sublime Security now runs beautifully on Kubernetes with Authentik SSO. The platform is protecting my homelab email, and I can write custom detection rules to catch those pesky &ldquo;Nigerian prince&rdquo; emails.</p>
<h2 id="full-deployment-files">Full Deployment Files</h2>
<p>All the Kubernetes manifests are available in my homelab repo. Here&rsquo;s the structure:</p>
<pre tabindex="0"><code>apps/sublime/
â”œâ”€â”€ namespace.yaml
â”œâ”€â”€ sealed-sublime-secrets.yaml
â”œâ”€â”€ postgres-deployment.yaml
â”œâ”€â”€ redis-deployment.yaml
â”œâ”€â”€ minio-deployment.yaml
â”œâ”€â”€ strelka-configs.yaml
â”œâ”€â”€ strelka-deployment.yaml
â”œâ”€â”€ mantis-deployment.yaml
â”œâ”€â”€ bora-lite-deployment.yaml
â”œâ”€â”€ dashboard-deployment.yaml
â”œâ”€â”€ screenshot-deployment.yaml
â”œâ”€â”€ hydra-deployment.yaml
â””â”€â”€ ingress.yaml
</code></pre><h2 id="final-thoughts">Final Thoughts</h2>
<p>Is running Sublime Security on Kubernetes overkill for a homelab? Absolutely.
Did I learn a ton about SAML, OIDC, and the importance of environment variables? You bet.
Would I do it again? &hellip;Ask me after I&rsquo;ve recovered.</p>
<p>But here&rsquo;s the thing - this is what homelabbing is all about. Taking enterprise software, bending it to your will, and learning valuable skills in the process. Plus, now you have enterprise-grade email security running in your cluster. How cool is that?</p>
<p>Remember: Every 502 error is a learning opportunity, every misconfigured environment variable is a chance to grow, and every successful deployment is a victory worth celebrating.</p>
<p>Happy homelabbing, and may your SSO always redirect to the right domain! ðŸš€</p>
<hr>
<p><em>P.S. - If you&rsquo;re from Sublime Security and reading this: Please add official Kubernetes support. My sanity thanks you in advance.</em></p>

  
  <hr>
<div class="footer">
    
	    
            <a class="previous-post" href="//localhost:1313/posts/finding-hardware/?ref=footer"><span style="font-weight:bold;">Â« Previous</span><br>Getting Started with Home Lab Equipment on a...</a>
        
	    
    
</div>

  
</div>
            </main>
            
  
    <div class="article-toc ">
    <div class="toc-wrapper">
      <h4 id="contents"></h4>
      <nav id="TableOfContents">
  <ul>
    <li><a href="#the-beginning-this-looks-cool">The Beginning: &ldquo;This Looks Cool!&rdquo;</a></li>
    <li><a href="#why-sublime-security">Why Sublime Security?</a></li>
    <li><a href="#the-challenge-docker-compose--kubernetes">The Challenge: Docker Compose â†’ Kubernetes</a></li>
    <li><a href="#prerequisites-what-youll-need">Prerequisites: What You&rsquo;ll Need</a></li>
    <li><a href="#step-1-understanding-the-architecture">Step 1: Understanding the Architecture</a></li>
    <li><a href="#step-2-setting-up-the-namespace-and-secrets">Step 2: Setting Up the Namespace and Secrets</a></li>
    <li><a href="#step-3-deploy-postgresql">Step 3: Deploy PostgreSQL</a></li>
    <li><a href="#step-4-deploy-redis-and-minio">Step 4: Deploy Redis and MinIO</a></li>
    <li><a href="#step-5-the-strelka-beast">Step 5: The Strelka Beast</a></li>
    <li><a href="#step-6-the-core-services---mantis-and-bora-lite">Step 6: The Core Services - Mantis and Bora-lite</a></li>
    <li><a href="#step-7-the-ingress-dance">Step 7: The Ingress Dance</a></li>
    <li><a href="#step-8-initial-setup-before-sso">Step 8: Initial Setup (Before SSO)</a></li>
    <li><a href="#step-9-the-sso-saga-begins">Step 9: The SSO Saga Begins</a>
      <ul>
        <li><a href="#setting-up-saml-in-authentik">Setting up SAML in Authentik:</a></li>
        <li><a href="#the-plot-twist-its-not-saml-its-the-redirect">The Plot Twist: It&rsquo;s Not SAML, It&rsquo;s the Redirect!</a></li>
        <li><a href="#alternative-use-oidc-instead">Alternative: Use OIDC Instead</a></li>
      </ul>
    </li>
    <li><a href="#troubleshooting-tips">Troubleshooting Tips</a>
      <ul>
        <li><a href="#connection-refused-or-502-bad-gateway">&ldquo;Connection refused&rdquo; or &ldquo;502 Bad Gateway&rdquo;</a></li>
        <li><a href="#sso_error-after-authentication">&ldquo;SSO_ERROR&rdquo; after authentication</a></li>
        <li><a href="#dashboard-shows-500-error">Dashboard shows 500 error</a></li>
        <li><a href="#strelka-connection-issues">Strelka connection issues</a></li>
      </ul>
    </li>
    <li><a href="#lessons-learned">Lessons Learned</a></li>
    <li><a href="#the-victory-lap">The Victory Lap</a></li>
    <li><a href="#full-deployment-files">Full Deployment Files</a></li>
    <li><a href="#final-thoughts">Final Thoughts</a></li>
  </ul>
</nav>
    </div>
</div>

  

        </div>
    </body>
</html>
